Parameters: 
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  InstanceType: 
    Type: String
    Default: t2.small
    AllowedValues: 
      - t2.small
      - c5.large
      - c5.xlarge
      - c5.2xlarge
    Description: Enter t2.small, c5.large, c5.xlarge, c5.2xlarge. Default is t2.small.
  ImageResourceId: 
    Type: AWS::EC2::Image::Id
    Default: ami-08fdde86b93accf1c #Ubuntu 16.04
    AllowedValues: 
      - ami-08fdde86b93accf1c #Amazon Linux 2 AMI
    Description: Choose the system image to run on.
  SteamUsername: 
    Type: String
    Default: user
    Description: Enter a steam username
  SteamPassword: 
    Type: String
    Default: user
    Description: Enter a steam password
  ServerName: 
    Type: String
    Default: RODefaultServer
    Description: Enter a name for the server
  ServerShortName: 
    Type: String
    Default: RODefaultServer
    Description: Enter a short name for the server
  GamePassword: 
    Type: String
    Default: ""
    Description: Enter a password to join the game. Leave blank for no password
  AdminPassword: 
    Type: String
    Description: Enter an administrator password for ingame and webadmin.
  MaxPlayers: 
    Type: String
    Default: 16
    Description: Enter the maximum number of players. Up to 64. Make sure you are running on a larger instance if above 40.

Resources:
  ROServerEC2:
    Type: AWS::EC2::Instance
    Properties:
        ImageId: !Ref ImageResourceId
        KeyName: !Ref KeyName
        InstanceType: !Ref InstanceType
        SecurityGroups:
        - !Ref SSHSecurityGroup
        - !Ref ROSecurityGroup
        BlockDeviceMappings:
        -
          DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 51
        UserData:
          'Fn::Base64': !Sub |
            #!/bin/bash -ex
              yum update -y aws-cfn-bootstrap
            /opt/aws/bin/cfn-init -v -s ${AWS::StackName} -r ROServerEC2 --region ${AWS::Region}
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              "glibc.i686": []
          sources:
            /opt/games/steam: "https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz"
          users:
            steam: 
              uid: "50"
              homeDir: "/opt/games"
          files:
            /opt/games/config/cloudformation-info.txt: 
              content: !Sub | 
                CREATED ON INSTANCE ${InstanceType};
              mode: "000644"
              owner: "steam"
              group: "steam"
            /opt/games/config/start-ro.sh: 
              content: !Sub | 
                #!/bin/bash
                echo 1200 > /opt/games/redorchestra/system/steam_appid.txt
                cd /opt/games/redorchestra/system/
                ./ucc-bin server RO-Barashka.rom?game=ROGame.ROTeamGame?VACSecured=True?
              mode: "000755"
              owner: "steam"
              group: "steam"
            /etc/init.d/redorchestra: 
              content: !Sub | 
                #!/bin/bash
                #
                # chkconfig: - 90 13
                # processname: redorchestra
                # pidfile: /opt/games/config/server.pid
                #
                # Based off 7 days file at https://7daystodie.gamepedia.com/Linux_Server_with_Amazon_Linux_AMI
                ### BEGIN INIT INFO
                # Provides: redorchestra
                # Required-Start: $local_fs $remote_fs $network Xvfb
                # Required-Stop: $local_fs $remote_fs $network
                ### END INIT INFO
                
                ##############
                ### CONFIG ###
                ##############
                #
                # This is the section to modify for different install
                # directories, game user accounts, etc.
                #
                
                # Parent directory for all games
                GAME_ROOT_DIR='/opt/games/config'
                # Name of the game; assumed to match init script name
                GAME_NAME='redorchestra'
                # Directory name for this game
                GAME_DIR_NAME=${!GAME_NAME}
                # User to run the game as
                GAME_USER='steam'
                # Name of this game
                # Binary used to start the game
                GAME_BIN_NAME='start-ro.sh'
                
                # Derived game dir
                game_dir="${!GAME_ROOT_DIR}"
                # Game command line options
                game_options=""
                # PID file location
                pidfile="${!game_dir}/server.pid"
                # Game binary full path
                game_bin="${!game_dir}/${!GAME_BIN_NAME}"
                
                ##################
                ### END CONFIG ###
                ##################
                
                RETVAL=0
                
                # Source function library.
                . /etc/rc.d/init.d/functions
                
                start() {
                        echo -n $"Starting ${!GAME_NAME}: "
                
                        su -l ${!GAME_USER} -c "${!game_bin} ${!game_options} 1>/dev/null 2>&1 & echo \$! >${!pidfile}"
                        sleep 1
                        service ${!GAME_NAME} status >/dev/null 2>&1
                        if [ "$?" = "0" ]
                        then
                                success
                                RETVAL=0
                        else
                                failure
                                RETVAL=1
                        fi
                        echo
                }
                stop() {
                        echo -n $"Stopping ${!GAME_NAME}: "
                        killproc -p ${!pidfile} -d 10 ${!game_bin}
                        RETVAL=$?
                        echo
                }
                
                # See how we were called.
                case "$1" in
                  start)
                        start
                        ;;
                  stop)
                        stop
                        ;;
                  status)
                        if ! test -f ${!pidfile}; then
                            echo ${!GAME_NAME} is stopped
                            RETVAL=3
                        else
                            status -p ${!pidfile} ${!game_bin}
                            RETVAL=$?
                        fi
                        ;;
                  *)
                        echo $"Usage: ${!GAME_NAME} {start|stop|status}"
                        exit 1
                esac
                
                exit $RETVAL
              mode: "000755"
              owner: "root"
              group: "root"
            /opt/games/.redorchestra/System/RedOrchestra.ini: 
              content: !Sub | 
                [URL]
                Protocol=RedOrchestra
                ProtocolDescription=RedOrchestra Protocol
                Name=ROSoldier
                Map=Index.rom
                LocalMap=ROintro.rom
                NetBrowseMap=Entry.rom
                Host=
                Portal=
                MapExt=rom
                EXEName=RedOrchestra.exe
                SaveExt=usa
                Port=7757
                Class=Engine.Pawn
                Character=Gorge
                
                [FirstRun]
                FirstRun=0
                
                [Engine.Engine]
                RenderDevice=D3D9Drv.D3D9RenderDevice
                ;RenderDevice=D3DDrv.D3DRenderDevice
                ;RenderDevice=Engine.NullRenderDevice
                ;RenderDevice=OpenGLDrv.OpenGLRenderDevice
                ;RenderDevice=PixoDrv.PixoRenderDevice
                AudioDevice=ALAudio.ALAudioSubsystem
                NetworkDevice=IpDrv.TcpNetDriver
                DemoRecordingDevice=Engine.DemoRecDriver
                Console=ROInterface.ROConsole
                GUIController=ROInterface.ROGUIController
                StreamPlayer=Engine.StreamInteraction
                Language=int
                Product=RedOrchestra
                GameEngine=Engine.GameEngine
                EditorEngine=Editor.EditorEngine
                DefaultGame=ROGame.ROTeamGame
                DefaultServerGame=ROGame.ROTeamGame
                ViewportManager=WinDrv.WindowsClient
                ;ViewportManager=SDLDrv.SDLClient
                Render=Render.Render
                Input=Engine.Input
                Canvas=Engine.Canvas
                DetectedVideoMemory=0
                ServerReadsStdin=False
                
                [Core.System]
                PurgeCacheDays=30
                SavePath=..\Save
                CachePath=../Cache
                CacheExt=.uxx
                CacheRecordPath=../System/*.ucl
                MusicPath=../Music
                SpeechPath=../Speech
                Paths=../System/*.u
                Paths=../Maps/*.rom
                Paths=../Textures/*.utx
                Paths=../Sounds/*.uax
                Paths=../Music/*.umx
                Paths=../StaticMeshes/*.usx
                Paths=../Animations/*.ukx
                Paths=../Saves/*.uvx
                Suppress=DevLoad
                Suppress=DevSave
                Suppress=DevNetTraffic
                Suppress=DevGarbage
                Suppress=DevKill
                Suppress=DevReplace
                Suppress=DevCompile
                Suppress=DevBind
                Suppress=DevBsp
                Suppress=DevNet
                Suppress=DevLIPSinc
                Suppress=DevKarma
                Suppress=RecordCache
                Suppress=MapVoteDebug
                Suppress=Init
                suppress=MapVote
                Suppress=VoiceChat
                Suppress=ChatManager
                Suppress=Timer
                Paths=../Textures/Old2k4/*.utx
                Paths=../Sounds/Old2k4/*.uax
                Paths=../Music/Old2k4/*.umx
                Paths=../StaticMeshes/Old2k4/*.usx
                Paths=../Animations/Old2k4/*.ukx
                Paths=../KarmaData/Old2k4/*.ka
                
                [Engine.GameEngine]
                CacheSizeMegs=32
                UseSound=True
                VoIPAllowVAD=False
                ServerActors=IpDrv.MasterServerUplink
                ServerActors=UWeb.WebServer
                ServerPackages=Core
                ServerPackages=Engine
                ServerPackages=Fire
                ServerPackages=Editor
                ServerPackages=IpDrv
                ServerPackages=UWeb
                ServerPackages=GamePlay
                ServerPackages=UnrealGame
                ServerPackages=XGame
                ServerPackages=XInterface
                ServerPackages=GUI2K4
                ServerPackages=xVoting
                ;ServerPackages=OnslaughtBP
                UseStaticMeshBatching=True
                ColorHighDetailMeshes=False
                ColorSlowCollisionMeshes=False
                ColorNoCollisionMeshes=False
                ColorWorldTextures=False
                ColorPlayerAndWeaponTextures=False
                ColorInterfaceTextures=False
                MainMenuClass=ROInterface.ROMainMenu
                ConnectingMenuClass=ROInterface.ROServerLoading
                DisconnectMenuClass=ROInterface.RONetworkStatusMessage
                LoadingClass=ROInterface.ROServerLoading
                ServerPackages=ROEffects
                ServerPackages=ROEngine
                ServerPackages=ROGame
                ServerPackages=ROAmmo
                ServerPackages=ROInventory
                ServerPackages=ROInterface
                ServerPackages=RORoles
                ServerPackages=AHZ_ROVehicles
                ServerPackages=ROCustom
                
                [WinDrv.WindowsClient]
                WindowedViewportX=640
                WindowedViewportY=480
                FullscreenViewportX=800
                FullscreenViewportY=600
                MenuViewportX=640
                MenuViewportY=480
                Brightness=0.800000
                Contrast=0.700000
                Gamma=0.800000
                UseJoystick=False
                CaptureMouse=True
                StartupFullscreen=True
                ScreenFlashes=True
                NoLighting=False
                MinDesiredFrameRate=35.000000
                AnimMeshDynamicLOD=0.0
                Decals=True
                Coronas=True
                DecoLayers=True
                Projectors=True
                NoDynamicLights=False
                ReportDynamicUploads=False
                TextureDetailInterface=Normal
                TextureDetailTerrain=Normal
                TextureDetailWeaponSkin=Normal
                TextureDetailPlayerSkin=Normal
                TextureDetailWorld=Normal
                TextureDetailRenderMap=Normal
                TextureDetailLightmap=UltraHigh
                NoFractalAnim=False
                ScaleHUDX=0.0
                MouseXMultiplier=1.000
                MouseYMultiplier=1.000
                UseSpeechRecognition=True
                WeatherEffects=True
                DrawDistanceLOD=1.0
                
                [SDLDrv.SDLClient]
                WindowedViewportX=640
                WindowedViewportY=480
                FullscreenViewportX=800
                FullscreenViewportY=600
                MenuViewportX=640
                MenuViewportY=480
                Brightness=0.800000
                Contrast=0.700000
                Gamma=0.800000
                UseJoystick=False
                JoystickNumber=0
                IgnoreHat=False
                JoystickHatNumber=0
                CaptureMouse=True
                StartupFullscreen=True
                ScreenFlashes=True
                NoLighting=False
                MinDesiredFrameRate=35.000000
                AnimMeshDynamicLOD=0.0
                Decals=True
                Coronas=True
                DecoLayers=True
                Projectors=True
                NoDynamicLights=False
                ReportDynamicUploads=False
                TextureDetailInterface=Normal
                TextureDetailTerrain=Normal
                TextureDetailWeaponSkin=Normal
                TextureDetailPlayerSkin=Normal
                TextureDetailWorld=Normal
                TextureDetailRenderMap=Normal
                TextureDetailLightmap=UltraHigh
                TextureMaxLOD=0
                TextureMinLOD=0
                NoFractalAnim=False
                WeatherEffects=True
                DrawDistanceLOD=1.0
                IgnoreUngrabbedMouse=False
                AllowUnicodeKeys=False
                AllowCommandQKeys=True
                MacFakeMouseButtons=True
                MacKeepAllScreensOn=False
                TextToSpeechFile=
                MacNativeTextToSpeech=True
                
                [ALAudio.ALAudioSubsystem]
                UseEAX=False
                Use3DSound=False
                UseDefaultDriver=True
                CompatibilityMode=False
                MaxEAXVersion=255
                UsePrecache=True
                ReverseStereo=False
                Channels=32
                MusicVolume=0.10000
                AmbientVolume=0.500000
                SoundVolume=0.30000
                VoiceVolume=4.000000
                VolumeScaleRec=0.100000
                DopplerFactor=1.0
                Rolloff=0.5
                TimeBetweenHWUpdates=15
                DisablePitch=False
                LowQualitySound=False
                UseVoIP=True
                UseVAD=False
                UseSpatializedVoice=False
                SpatializedVoiceRadius=100000
                EnhancedDenoiser=False
                LocalZOffset=0.0
                DampenWithVoIP=False
                
                [IpDrv.TcpNetDriver]
                AllowDownloads=True
                ConnectionTimeout=30.0
                InitialConnectTimeout=200.0
                AckTimeout=1.0
                KeepAliveTime=0.2
                MaxClientRate=15000
                MaxInternetClientRate=10000
                SimLatency=0
                RelevantTimeout=5.0
                SpawnPrioritySeconds=1.0
                ServerTravelPause=4.0
                NetServerMaxTickRate=20
                LanServerMaxTickRate=35
                DownloadManagers=IpDrv.HTTPDownload
                DownloadManagers=Engine.ChannelDownload
                AllowPlayerPortUnreach=False
                LogPortUnreach=False
                MaxConnPerIPPerMinute=5
                LogMaxConnPerIPPerMin=False
                
                [IpServer.UdpServerQuery]
                GameName=rom
                
                [IpDrv.MasterServerUplink]
                DoUplink=False
                UplinkToGamespy=True
                SendStats=False
                ServerBehindNAT=True
                DoLANBroadcast=True
                
                [IpDrv.MasterServerLink]
                LANPort=11757
                LANServerPort=10757
                
                [IpDrv.HTTPDownload]
                RedirectToURL=
                ProxyServerHost=
                ProxyServerPort=3128
                UseCompression=True
                
                [Engine.DemoRecDriver]
                AllowDownloads=True
                DemoSpectatorClass=UnrealGame.DemoRecSpectator
                MaxClientRate=25000
                ConnectionTimeout=15.0
                InitialConnectTimeout=200.0
                AckTimeout=1.0
                KeepAliveTime=1.0
                SimLatency=0
                RelevantTimeout=5.0
                SpawnPrioritySeconds=1.0
                ServerTravelPause=4.0
                NetServerMaxTickRate=30
                LanServerMaxTickRate=30
                
                [Engine.GameReplicationInfo]
                ServerName=${ServerName}
                ShortName=${ServerShortName}
                ServerRegion=0
                AdminName=
                AdminEmail=
                MessageOfTheDay=
                
                [D3DDrv.D3DRenderDevice]
                DetailTextures=True
                HighDetailActors=True
                SuperHighDetailActors=True
                UsePrecaching=True
                UseTrilinear=True
                AdapterNumber=-1
                ReduceMouseLag=True
                UseTripleBuffering=False
                UseHardwareTL=True
                UseHardwareVS=True
                UseCubemaps=True
                DesiredRefreshRate=60
                UseCompressedLightmaps=True
                UseStencil=False
                Use16bit=False
                Use16bitTextures=False
                MaxPixelShaderVersion=255
                UseVSync=True
                LevelOfAnisotropy=1
                DetailTexMipBias=0.0
                DefaultTexMipBias=-0.5
                UseNPatches=False
                TesselationFactor=1.0
                CheckForOverflow=False
                AvoidHitches=False
                OverrideDesktopRefreshRate=False
                ReportUnusedTextures=False
                
                [D3D9Drv.D3D9RenderDevice]
                DetailTextures=True
                HighDetailActors=True
                SuperHighDetailActors=True
                UsePrecaching=True
                UseTrilinear=True
                AdapterNumber=-1
                ReduceMouseLag=True
                UseTripleBuffering=False
                UseHardwareTL=True
                UseHardwareVS=True
                UseCubemaps=True
                DesiredRefreshRate=60
                UseCompressedLightmaps=True
                UseStencil=False
                Use16bit=False
                Use16bitTextures=False
                MaxPixelShaderVersion=255
                UseVSync=False
                LevelOfAnisotropy=1
                DetailTexMipBias=0.0
                DefaultTexMipBias=-0.5
                UseNPatches=False
                TesselationFactor=1.0
                CheckForOverflow=False
                OverrideDesktopRefreshRate=False
                
                [OpenGLDrv.OpenGLRenderDevice]
                DetailTextures=True
                HighDetailActors=True
                SuperHighDetailActors=True
                UsePrecaching=True
                UseCompressedLightmaps=True
                UseTrilinear=True
                UseStencil=False
                MaxTextureUnits=8
                VARSize=32
                ReduceMouseLag=True
                UseVSync=False
                LevelOfAnisotropy=1.0
                DetailTexMipBias=0.0
                DefaultTexMipBias=-0.5
                UseVBO=False
                UseVSync=False
                AppleVA=1
                MultisampleBuffers=0
                MultisampleSamples=0
                MultisampleHint=2
                
                [PixoDrv.PixoRenderDevice]
                FogEnabled=True
                Zoom2X=True
                SimpleMaterials=True
                LimitTextureSize=True
                LowQualityTerrain=True
                TerrainLOD=10
                SkyboxHack=True
                FilterQuality3D=1
                FilterQualityHUD=1
                HighDetailActors=False
                SuperHighDetailActors=False
                ReduceMouseLag=False
                DesiredRefreshRate=0
                DetailTexMipBias=0.000000
                Use16bitTextures=False
                Use16bit=True
                UseStencil=False
                UseCompressedLightmaps=False
                DetailTextures=False
                UsePrecaching=True
                
                [Engine.NullRenderDevice]
                DetailTextures=True
                HighDetailActors=True
                SuperHighDetailActors=True
                UsePrecaching=True
                UseCompressedLightmaps=True
                UseStencil=False
                
                [Editor.EditorEngine]
                UseSound=True
                CacheSizeMegs=32
                GridEnabled=True
                SnapVertices=False
                SnapDistance=1.000000
                GridSize=(X=4.000000,Y=4.000000,Z=4.000000)
                RotGridEnabled=True
                RotGridSize=(Pitch=1024,Yaw=1024,Roll=1024)
                GameCommandLine=-log
                FovAngleDegrees=90.000000
                GodMode=True
                AutoSave=True
                AutoSaveTimeMinutes=5
                AutoSaveIndex=6
                UseAxisIndicator=True
                MatineeCurveDetail=0.1
                ShowIntWarnings=False
                UseSizingBox=True
                RenderDevice=D3DDrv.D3DRenderDevice
                AudioDevice=ALAudio.ALAudioSubsystem
                NetworkDevice=IpDrv.TcpNetDriver
                DemoRecordingDevice=Engine.DemoRecDriver
                Console=Engine.Console
                Language=ute
                AlwaysShowTerrain=False
                UseActorRotationGizmo=False
                LoadEntirePackageWhenSaving=0
                EditPackages=Core
                EditPackages=Engine
                EditPackages=Fire
                EditPackages=Editor
                EditPackages=UnrealEd
                EditPackages=IpDrv
                EditPackages=UWeb
                EditPackages=GamePlay
                EditPackages=UnrealGame
                EditPackages=XGame
                EditPackages=XInterface
                EditPackages=XAdmin
                EditPackages=XWebAdmin
                EditPackages=GUI2K4
                EditPackages=xVoting
                EditPackages=UTV2004c
                EditPackages=UTV2004s
                EditPackages=ROEffects
                EditPackages=ROEngine
                EditPackages=ROGame
                EditPackages=ROAmmo
                EditPackages=ROInventory
                EditPackages=ROInterface
                EditPackages=RORoles
                EditPackages=ROVehicles
                CutdownPackages=Core
                CutdownPackages=Editor
                CutdownPackages=Engine
                CutdownPackages=Fire
                CutdownPackages=GamePlay
                CutdownPackages=GUI2K4
                CutdownPackages=IpDrv
                CutdownPackages=Onslaught
                CutdownPackages=UnrealEd
                CutdownPackages=UnrealGame
                CutdownPackages=UWeb
                CutdownPackages=XAdmin
                CutdownPackages=XEffects
                CutdownPackages=XInterface
                CutdownPackages=XPickups
                CutdownPackages=XWebAdmin
                CutdownPackages=XVoting
                
                [UWeb.WebServer]
                Applications[0]=xWebAdmin.UTServerAdmin
                ApplicationPaths[0]=/ServerAdmin
                Applications[1]=xWebAdmin.UTImageServer
                ApplicationPaths[1]=/images
                bEnabled=True
                ListenPort=8075
                
                [Engine.Console]
                ConsoleHotKey=9
                TimePerTitle=30.0
                TimePerDemo=60.0
                TimePerSoak=3600.0
                TimeTooIdle=60.0
                DemoLevels[0]=DM-Curse3
                DemoLevels[1]=DM-Antalus
                DemoLevels[2]=CTF-Chrome
                DemoLevels[3]=DOM-SunTemple
                DemoLevels[4]=BR-Endagra
                
                [Engine.AccessControl]
                AdminPassword=${AdminPassword}
                GamePassword=${GamePassword}
                bBanByID=True
                
                [Engine.GameInfo]
                GoreLevel=2
                MaxSpectators=2
                MaxPlayers=${MaxPlayers}
                AutoAim=1.000000
                GameSpeed=1.000000
                bChangeLevels=True
                bStartUpLocked=False
                bNoBots=False
                bAttractAlwaysFirstPerson=False
                NumMusicFiles=13
                bEnableStatLogging=False
                HUDType=Engine.Hud
                MaxLives=0
                TimeLimit=0
                GoalScore=0
                GameStatsClass=IpDrv.MasterServerGameStats
                SecurityClass=UnrealGame.UnrealSecurity
                AccessControlClass=Engine.AccessControl
                VotingHandlerType=xVoting.xVotingHandler
                MaxIdleTime=+0.0
                bVACSecured=False
                
                [Engine.AmbientSound]
                AmbientVolume=0.25
                
                [Engine.LevelInfo]
                PhysicsDetailLevel=PDL_Medium
                MeshLODDetailLevel=MDL_Ultra
                bLowSoundDetail=False
                DecalStayScale=1.0
                bNeverPrecache=false
                TimeMarginSlack=1.35
                MaxClientFrameRate=+90.0
                
                [XInterface.ExtendedConsole]
                ConsoleHotKey=192
                NeedPasswordMenuClass=GUI2K4.UT2K4GetPassword
                bSpeechMenuUseMouseWheel=True
                bSpeechMenuUseLetters=False
                SMOriginX=0.01
                SMOriginY=0.3
                LetterKeys[0]=IK_Q
                LetterKeys[1]=IK_W
                LetterKeys[2]=IK_E
                LetterKeys[3]=IK_R
                LetterKeys[4]=IK_A
                LetterKeys[5]=IK_S
                LetterKeys[6]=IK_D
                LetterKeys[7]=IK_F
                LetterKeys[8]=IK_Z
                LetterKeys[9]=IK_X
                MusicManagerClassName=GUI2K4.StreamPlayer
                
                [XGame.xDeathMatch]
                HUDType=XInterface.HudBDeathMatch
                MaxLives=0
                TimeLimit=20
                GoalScore=25
                bTeamScoreRound=False
                bPlayersMustBeReady=False
                bAllowTaunts=True
                bForceRespawn=False
                bWeaponStay=true
                
                [XGame.xTeamGame]
                HUDType=XInterface.HudBTeamDeathMatch
                MaxLives=0
                TimeLimit=20
                GoalScore=60
                bTeamScoreRound=False
                bPlayersMustBeReady=False
                bAllowTaunts=True
                FriendlyFireScale=0
                MaxTeamSize=16
                bForceRespawn=False
                bWeaponStay=true
                
                [XGame.xCTFGame]
                HUDType=XInterface.HudBCaptureTheFlag
                MaxLives=0
                TimeLimit=20
                GoalScore=3
                bTeamScoreRound=False
                bPlayersMustBeReady=False
                bAllowTaunts=True
                FriendlyFireScale=0
                MaxTeamSize=16
                bForceRespawn=False
                bWeaponStay=true
                
                [XGame.xDoubleDom]
                HUDType=XInterface.HudBDoubleDomination
                MaxLives=0
                TimeLimit=20
                GoalScore=3
                bTeamScoreRound=False
                bPlayersMustBeReady=False
                bAllowTaunts=True
                TimeToScore=10
                TimeDisabled=10
                FriendlyFireScale=0
                MaxTeamSize=16
                bForceRespawn=False
                bWeaponStay=true
                
                [XGame.xBombingRun]
                HUDType=XInterface.HudBBombingRun
                MaxLives=0
                TimeLimit=20
                GoalScore=15
                bTeamScoreRound=False
                bPlayersMustBeReady=False
                bAllowTaunts=True
                FriendlyFireScale=0
                MaxTeamSize=16
                bForceRespawn=False
                bWeaponStay=true
                
                [Engine.MaplistManager]
                Games=(GameType="BonusPack.xLastManStandingGame",ActiveMaplist="Default LMS")
                Games=(GameType="BonusPack.xMutantGame",ActiveMaplist="Default MUT")
                Games=(GameType="Onslaught.ONSOnslaughtGame",ActiveMaplist="Default ONS")
                Games=(GameType="SkaarjPack.Invasion",ActiveMaplist="Default INV")
                Games=(GameType="UT2k4Assault.ASGameInfo",ActiveMaplist="Default AS")
                Games=(GameType="XGame.xBombingRun",ActiveMaplist="Default BR")
                Games=(GameType="XGame.xCTFGame",ActiveMaplist="Default CTF")
                Games=(GameType="XGame.xDeathMatch",ActiveMaplist="Default DM")
                Games=(GameType="XGame.xDoubleDom",ActiveMaplist="Default DOM2")
                Games=(GameType="XGame.xTeamGame",ActiveMaplist="Default TDM")
                Games=(GameType="XGame.xVehicleCTFGame",ActiveMaplist=)
                Games=(GameType="ROEngine.ROTeamGame",ActiveMaplist="Default RO")
                
                [XInterface.MapListDeathMatch]
                MapNum=0
                Maps=DM-RRAJIGAR
                Maps=DM-RANKIN
                Maps=DM-CORRUGATION
                Maps=DM-DE-GRENDELKEEP
                Maps=DM-DE-IRONIC
                Maps=DM-DE-OSIRIS2
                Maps=DM-GESTALT
                Maps=DM-IRONDEITY
                Maps=DM-METALLURGY
                Maps=DM-Deck17
                Maps=DM-Antalus
                Maps=DM-Asbestos
                Maps=DM-Curse4
                
                [XInterface.MapListTeamDeathMatch]
                MapNum=0
                Maps=DM-RRAJIGAR
                Maps=DM-RANKIN
                Maps=DM-CORRUGATION
                Maps=DM-DE-GRENDELKEEP
                Maps=DM-DE-IRONIC
                Maps=DM-DE-OSIRIS2
                Maps=DM-GESTALT
                Maps=DM-IRONDEITY
                Maps=DM-METALLURGY
                Maps=DM-Deck17
                Maps=DM-Antalus
                Maps=DM-Asbestos
                Maps=DM-Curse4
                
                [XInterface.MapListCaptureTheFlag]
                MapNum=0
                Maps=CTF-ABSOLUTEZERO
                Maps=CTF-MOONDRAGON
                Maps=CTF-GRASSYKNOLL
                Maps=CTF-COLOSSUS
                Maps=CTF-SMOTE
                Maps=CTF-DOUBLEDAMMAGE
                Maps=CTF-AVARIS
                Maps=CTF-BRIDGEOFFATE
                Maps=CTF-FaceClassic
                Maps=CTF-CHROME
                Maps=CTF-Citadel
                Maps=CTF-Orbital2
                
                [Default RO MaplistRecord]
                DefaultTitle=Default RO
                DefaultGameType=ROEngine.ROTeamGame
                DefaultActive=3
                DefaultMaps=RO-FallenHeroes
                DefaultMaps=RO-KrivoiRog
                DefaultMaps=RO-Danzig
                DefaultMaps=RO-Arad
                DefaultMaps=RO-Barashka
                DefaultMaps=RO-Basovka
                DefaultMaps=RO-Bondarevo
                DefaultMaps=RO-HedgeHog
                DefaultMaps=RO-Kaukasus
                DefaultMaps=RO-KrasnyiOktyabr
                DefaultMaps=RO-Ogledow
                DefaultMaps=RO-Odessa
                DefaultMaps=RO-StalingradKessel
                DefaultMaps=RO-KonigsPlatz
                DefaultMaps=RO-Rakowice
                DefaultMaps=RO-BaksanValley
                DefaultMaps=RO-Berezina
                DefaultMaps=RO-BlackDayJuly
                DefaultMaps=RO-Kryukovo
                DefaultMaps=RO-KurlandKessel
                DefaultMaps=RO-Leningrad
                DefaultMaps=RO-Mannikkala
                DefaultMaps=RO-SmolenskStalemate
                DefaultMaps=RO-Tcherkassy
                DefaultMaps=RO-TulaOutskirts
                DefaultMaps=RO-Zhitomir1941
                
                [ROInterface.ROMapList]
                MapNum=0
                Maps=RO-FallenHeroes
                Maps=RO-KrivoiRog
                Maps=RO-Danzig
                Maps=RO-Arad
                Maps=RO-Barashka
                Maps=RO-Basovka
                Maps=RO-Bondarevo
                Maps=RO-HedgeHog
                Maps=RO-Kaukasus
                Maps=RO-KrasnyiOktyabr
                Maps=RO-Ogledow
                Maps=RO-Odessa
                Maps=RO-StalingradKessel
                Maps=RO-KonigsPlatz
                Maps=RO-Rakowice
                Maps=RO-BaksanValley
                Maps=RO-Berezina
                Maps=RO-BlackDayJuly
                Maps=RO-Kryukovo
                Maps=RO-KurlandKessel
                Maps=RO-Leningrad
                Maps=RO-Mannikkala
                Maps=RO-SmolenskStalemate
                Maps=RO-Tcherkassy
                Maps=RO-TulaOutskirts
                Maps=RO-Zhitomir1941
                
                [ROEngine.ROTeamGame]
                WinLimit=2
                RoundLimit=3
                TimeLimit=0
                PreStartTime=30
                DeathMessageMode=DM_All
                FFPunishment=FFP_Kick
                FriendlyFireScale=1.000000
                FFKillLimit=4
                FFDamageLimit=800
                FFArtyScale=0.200000
                FFExplosivesScale=0.500000
                bSpectateFirstPersonOnly=False
                bSpectateLockedBehindView=False
                bSpectateAllowViewPoints=True
                bSpectateAllowRoaming=True
                bSpectateAllowDeadRoaming=False
                bSpectateBlackoutWhenDead=False
                bSpectateBlackoutWhenNotViewingPlayers=False
                bAllowNonTeamChat=False
                
                [ROEngine.ROWeaponAttachment]
                WeaponAmbientScale=5.0
                
                [xVoting.xVotingHandler]
                VoteTimeLimit=70
                ScoreBoardDelay=5
                bAutoOpen=True
                MidGameVotePercent=50
                bScoreMode=False
                bAccumulationMode=False
                bEliminationMode=False
                MinMapCount=1
                MapVoteHistoryType=xVoting.MapVoteHistory_INI
                RepeatLimit=1
                DefaultGameConfig=0
                bDefaultToCurrentGameType=True
                bMapVote=True
                bKickVote=True
                bMatchSetup=False
                KickPercent=25
                bAnonymousKicking=True
                MapListLoaderType=xVoting.DefaultMapListLoader
                ServerNumber=1
                CurrentGameConfig=0
                
                [xVoting.DefaultMapListLoader]
                bUseMapList=true
                MapNamePrefixes=RO
                
                [UnrealGame.TeamGame]
                bBalanceTeams=True
                bPlayersBalanceTeams=True
                
                [ROFirstRun]
                ROFirstRun=1087

              mode: "000644"
              owner: "steam"
              group: "steam"
          commands:
            00_install_test: 
              command: "echo ./steamcmd.sh +login $STEAMUSER $STEAMPASS +force_install_dir /opt/redorchestra +app_update 223250 validate > /home/ec2-user/steaminstall-0.txt"
              cwd: "~"
              env: 
                STEAMUSER: !Ref SteamUsername
                STEAMPASS: !Ref SteamPassword
            01_install: 
              command: "/opt/games/steam/steamcmd.sh +login $STEAMUSER $STEAMPASS +force_install_dir /opt/games/redorchestra +app_update 223250 validate +quit"
              cwd: "/opt/games/steam"
              env: 
                STEAMUSER: !Ref SteamUsername
                STEAMPASS: !Ref SteamPassword
            02_validate: 
              command: "/opt/games/steam/steamcmd.sh +login $STEAMUSER $STEAMPASS +force_install_dir /opt/games/redorchestra +app_update 223250 validate +quit"
              cwd: "/opt/games/steam"
              env: 
                STEAMUSER: !Ref SteamUsername
                STEAMPASS: !Ref SteamPassword
            03_correct_owner: 
              command: "chown steam -R /opt/games"
              cwd: "~"
            04_correct_group: 
              command: "chgrp steam -R /opt/games"
              cwd: "~"
            05_correct_permissions: 
              command: "chmod 0755 -R /opt/games"
              cwd: "~"
            06_setup_service: 
              command: "chkconfig redorchestra on"
              cwd: "~"
            07_setup_shell: 
              command: "usermod --shell /bin/bash steam"
              cwd: "~"
            08_reboot: 
              command: "reboot"
              cwd: "~"
      
        

  SSHSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH access via port 22
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 22
        IpProtocol: tcp
        ToPort: 22

  ROSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable Steam and Red Orchestra
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 7757
        IpProtocol: udp
        ToPort: 7757
      - CidrIp: 0.0.0.0/0
        FromPort: 7758
        IpProtocol: udp
        ToPort: 7758
      - CidrIp: 0.0.0.0/0
        FromPort: 7767
        IpProtocol: udp
        ToPort: 7767
      - CidrIp: 0.0.0.0/0
        FromPort: 28902
        IpProtocol: tcp
        ToPort: 28902
      - CidrIp: 0.0.0.0/0
        FromPort: 28902
        IpProtocol: udp
        ToPort: 28902
      - CidrIp: 0.0.0.0/0
        FromPort: 8075
        IpProtocol: tcp
        ToPort: 8075
      - CidrIp: 0.0.0.0/0
        FromPort: 20610
        IpProtocol: udp
        ToPort: 20610

Outputs:
  PublicIp:
    Description: Server Public IP
    Value: !GetAtt ROServerEC2.PublicIp
    Export:
      Name: !Sub "${AWS::StackName}-PublicIp"
  WebAdminURL:
    Description: Web Admin URL
    Value: http://!GetAtt ROServerEC2.PublicIp:8075
    Export:
      Name: !Sub "${AWS::StackName}-WebAdminURL"